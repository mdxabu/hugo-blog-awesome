{{- $alt := .Text -}}
{{- $src := .Destination -}}
{{- $title := .Title -}}
{{- $caption := "" -}}
{{- $size := "" -}}

{{- /* Parse title for size and caption */ -}}
{{- if $title -}}
  {{- $parts := split $title "|" -}}
  {{- if eq (len $parts) 2 -}}
    {{- /* Format: "caption | size" */ -}}
    {{- $caption = trim (index $parts 0) " " -}}
    {{- $sizeRaw := trim (index $parts 1) " " | lower -}}
    {{- if or (eq $sizeRaw "small") (eq $sizeRaw "medium") (eq $sizeRaw "large") -}}
      {{- $size = $sizeRaw -}}
    {{- end -}}
  {{- else -}}
    {{- /* No size specified, just caption */ -}}
    {{- $caption = $title -}}
  {{- end -}}
{{- end -}}

{{- /* Check if the image path starts with / (absolute from static) */ -}}
{{- if hasPrefix $src "/" -}}
  {{- /* Path is already absolute from root */ -}}
{{- else if hasPrefix $src "static/" -}}
  {{- /* Remove 'static/' prefix and add leading slash */ -}}
  {{- $src = printf "/%s" (strings.TrimPrefix "static/" $src) -}}
{{- else if or (hasPrefix $src "http://") (hasPrefix $src "https://") -}}
  {{- /* External URL, keep as is */ -}}
{{- else -}}
  {{- /* Relative path, add leading slash */ -}}
  {{- $src = printf "/%s" $src -}}
{{- end -}}

<figure class="image-figure{{ if $size }} image-{{ $size }}{{ end }}">
  <img src="{{ $src | safeURL }}" alt="{{ $alt }}" {{ with $caption }}title="{{ . }}"{{ end }} loading="lazy">
  {{- if $caption -}}
  <figcaption>{{ $caption | markdownify }}</figcaption>
  {{- end -}}
</figure>
